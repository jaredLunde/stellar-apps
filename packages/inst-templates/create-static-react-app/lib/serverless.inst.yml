# NOTE:
# All variables are here:
# https://serverless.com/framework/docs/providers/aws/guide/serverless.yml/
service: <:ROOT_NAME:>-<:PKG_NAME:>

provider:
  name: aws
  runtime: nodejs8.10
  stage: ${opt:stage, 'production'}
  # AWS profile to use when deploying
  profile: ${env:SERVERLESS__PROFILE, ""}
  # AWS region to deploy into
  region: us-east-1
  # Optional function versioning
  versionFunctions: false
  # Set the default RetentionInDays for a CloudWatch LogGroup
  logRetentionInDays: 7
  deploymentBucket:
    # Deployment bucket name. Default is generated by the framework
    name: stellar-serverless-deploys
    serverSideEncryption: AES256
  # The S3 prefix under which deployed artifacts should be stored
  deploymentPrefix: artifacts
  # IAM role statements so that services can be accessed in the AWS account
  iamRoleStatements:
    - Effect: Allow
      Action:
        - cloudformation:DescribeStackResourc
      Resource: "*"

# SEE: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html
resources:
  Resources:
    # Creates a static site bucket named after the domain name
    StaticSiteS3Bucket:
      Type: AWS::S3::Bucket
      # DeletionPolicy: Retain
      Properties:
        AccessControl: PublicRead
        BucketName: ${self:custom.siteS3Bucket}
        WebsiteConfiguration:
          IndexDocument: index.html

    # Creates a bucket policy for the static site bucket
    StaticSiteS3BucketPolicy:
      Type: AWS::S3::BucketPolicy
      # Waits for the bucket to be created before attaching its policy
      DependsOn:
        - StaticSiteS3Bucket
      Properties:
        Bucket:
          # The Ref returned by StaticSiteS3Bucket is the name of the bucket
          Ref: StaticSiteS3Bucket
        PolicyDocument:
          Statement:
            - Sid: PublicReadGetObject
              Effect: Allow
              Principal: "*"
              Action:
                - s3:GetObject
              Resource:
                Fn::Join: ["", ["arn:aws:s3:::", {"Ref": "StaticSiteS3Bucket"}, "/*"]]

    # Creates a bucket for public assets
    # DELETE if using a shared or existing bucket
    ClientS3Bucket:
      Type: AWS::S3::Bucket
      DeletionPolicy: Retain
      Properties:
        # The bucket itself should be private by default for security, objects can
        # optionally be defined as public
        AccessControl: Private
        BucketName: ${self:custom.clientS3Bucket}
        CorsConfiguration:
          CorsRules:
            # By default, this only allows the static site's domain as an origin. You can
            # add more allowed origins to your leisure.
            - AllowedOrigins:
                - ${self:custom.domain}
              AllowedHeaders:
                - '*'
              AllowedMethods:
                - GET

    # Sets up the CloudFront distribution
    # This is necessary to deliver the static website over HTTPS, as S3 only allows
    # static sites of HTTP
    StaticCloudFrontDistribution:
      Type: AWS::CloudFront::Distribution
      # Waits for the static site bucket to be created before initiating
      DependsOn:
        - StaticSiteS3BucketPolicy
      Properties:
        DistributionConfig:
          Origins:
            - DomainName:
                # Gets the domain name returned by StaticSiteS3Bucket's creation e.g.
                # <bucket-name>.s3-website-<AWS-region>.amazonaws.com
                Fn::Join: ["", [{"Ref": "StaticSiteS3Bucket"}, ".s3-website-", {"Ref": "AWS::Region"}, ".amazonaws.com"]]
                # Fn::GetAtt:
                #   - StaticSiteS3Bucket
                #   - WebsiteURL

              Id:
                # Grabs the bucket name returned by StaticSiteS3Bucket's creation
                Ref: StaticSiteS3Bucket
              CustomOriginConfig:
                # These are the ports S3 websites listen on, though 443 actually won't be
                # used due to the OriginProtocolPolicy below
                HTTPPort: 80
                HTTPSPort: 443
                # Not sure this actually matters
                OriginSSLProtocols:
                  - TLSv1.1
                  - TLSv1
                # S3 websites only operate on HTTP, so this cannot be HTTPS, though that
                # would be desired
                OriginProtocolPolicy: http-only
          # This distribution can be temporarily disabled by defining 'false' here
          Enabled: 'true'
          # Delivers the distribution over HTTP/2 with a fallback to HTTP/1.1
          HttpVersion: http2
          # Selects the regions to deploy the distribution to. By default we are just deploying
          # to US, CAN, and EU.
          PriceClass: PriceClass_100  # US, CAN, EU
          # Sets up a custom domain name for the distribution
          Aliases:
            - ${self:custom.domain}
          # Attaches a custom certificate so that this distribution can use a custom domain
          ViewerCertificate:
            # Will be populated with @stellar-apps/serverless-certificate-manager
            AcmCertificateArn: ''
            MinimumProtocolVersion: TLSv1.1_2016
            SslSupportMethod: sni-only
          DefaultRootObject: index.html
          CustomErrorResponses:
            - ErrorCode: 404
              # Can easily be changed to /error.html should you create a custom error page
              # and proper 404 code if you wish
              ResponseCode: 200
              ResponsePagePath: /index.html
          # Sets up the CF cache behaviors for objects retrieved from the origin
          DefaultCacheBehavior:
            AllowedMethods:
              - GET
              - HEAD
            # Sets the StaticSiteS3Bucket name as its target origin ID
            TargetOriginId:
              Ref: StaticSiteS3Bucket
            ForwardedValues:
              QueryString: 'false'
              # You can optionally forward cookies to the origin server here, not necessary
              # with S3 static hosting, but could be useful if you had a lambda function
              # intermediary
              Cookies:
                Forward: none
            # Redirects HTTP requests to HTTPS so this distribution is always delivered
            # securely
            ViewerProtocolPolicy: redirect-to-https

    # Sets up Route 53 for the S3 static site CF distribution
    CloudFrontDnsRecord:
      Type: AWS::Route53::RecordSet
      # Waits for the CF distribution to finish before creating the record
      DependsOn:
        StaticCloudFrontDistribution
      Properties:
        # Sets up CloudFront as an ALIAS
        AliasTarget:
          DNSName:
            # Gets the domain name returned by StaticCloudFrontDistribution's creation
            Fn::GetAtt:
              - StaticCloudFrontDistribution
              - DomainName
          # The region where your Route 53 hosted zone exists.
          # This is the only HostedZoneId for CloudFront
          #
          # See here: https://docs.aws.amazon.com/general/latest/gr/rande.html#cf_region
          HostedZoneId: Z2FDTNDATAQYW2
        # This is the name of the hosted zone, e.g. `foo.com.`
        HostedZoneName: ${self:custom.hostedZone}
        # This is the name of the A record, e.g. `www.foo.com.`
        Name: ${self:custom.domain}.
        Type: 'A'

    # Redirects WWW to naked domain
    # StaticRedirectS3Bucket:
    #   Type: AWS::S3::Bucket
    #   # DeletionPolicy: Retain
    #   Properties:
    #     AccessControl: PublicRead
    #     BucketName: www.${self:custom.domain}
    #     WebsiteConfiguration:
    #       RedirectAllRequestsTo:
    #         Protocol: https
    #         HostName: ${self:custom.domain}
    # DNS record for apex redirect
    # StaticRedirectDnsRecord:
    #   Type: AWS::Route53::RecordSet
    #   DependsOn:
    #     - StaticRedirectS3Bucket
    #   Properties:
    #     AliasTarget:
    #       # These two values differ regionally, so make sure your values match your region
    #       # See here: https://docs.aws.amazon.com/general/latest/gr/rande.html#s3_website_region_endpoints
    #       DNSName: s3-website-us-east-1.amazonaws.com. # us-east-1
    #       HostedZoneId: Z3AQBSTGFYJSTF                 # us-east-1
    #     HostedZoneName: ${self:custom.hostedZone}
    #     Name:
    #       Ref: StaticRedirectS3Bucket
    #     Type: 'A'

plugins:
  # Loads environment variables defined in .env.[--stage]
  - '@stellar-apps/serverless-dotenv'
  # Creates ACM certificates for the app domains
  - '@stellar-apps/serverless-certificate-manager'
  # Used for running scripts on Serverless lifecycle hooks
  # - serverless-plugin-scripts
  # Deploys Webpack bundles to S3
  - '@stellar-apps/serverless-sync-bundle'

custom:
  # Defines the domain name being created in this template
  domain: ${env:DOMAIN}
  # Defines the S3 bucket for the static HTML site
  siteS3Bucket: ${env:SERVERLESS__SITE_S3_BUCKET, ""}
  # Defines the S3 bucket for client resources: images, js, json, etc.
  clientS3Bucket: ${env:SERVERLESS__CLIENT_S3_BUCKET, ""}
  # The hosted zone in Route 53 where the domain records reside
  hostedZone: ${env:SERVERLESS__HOSTED_ZONE, ""}
  # Creates ACM certificates for the app domains
  certificateManager:
    - refFor:
        - resources.Resources.StaticCloudFrontDistribution.Properties.DistributionConfig.ViewerCertificate.AcmCertificateArn
      # Make `false` to delete this certificate on teardown
      # This is `true` by default to avoid accidentally deleting a shared certificate
      retain: true
      domains:
        - <:DOMAIN_PRODUCTION:>
        - <:(value+=props.DOMAIN_PRODUCTION.split('.').length === 2 ? `'*.${props.DOMAIN_PRODUCTION}'` : props.DOMAIN_STAGING):>
  # Defines settings for the application bundles
  syncBundle:
    # Client-side bundle for JS, images, etc.
    # This must be executed before `server.config.js` because the 'server' code relies on it
    'webpack/client.config.js':
      bucket:
        # The name of the bucket where the client code will be deployed
        name: ${self:custom.clientS3Bucket}
        # Make `false` to empty this bucket on teardown
        # This is `true` by default to avoid accidentally nuking a shared bucket
        retain: true
      # Parameters passed to the AWS.S3() constructor in aws-sdk
      params:
        maxRetries: 5
      object:
        # Excludes the stats file generated with Webpack from being synced
        'stats.json':
          exclude: true
        '*':
          params:
            ACL: 'public-read'
            # Files should have hashes in their filenames based upon their content
            # and therefore be immutable, making them safe to cache indefinitely
            cacheControl: 'public, immutable, max-age=31536000'
    # 'Server-side' static website bundle, generates the static website (HTML) files
    'webpack/server.config.js':
      bucket:
        # The name of the bucket where the static website HTML will be deployed
        name: ${self:custom.siteS3Bucket}
        # Make `true` to retain this bucket on teardown
        retain: false
      # Parameters passed to the AWS.S3() constructor in aws-sdk
      params:
        maxRetries: 5
      object:
        # We don't need to push any JS files here, just HTML
        '**/*.js':
          exclude: true
        '**/robots.txt':
          params:
            ACL: 'public-read'
            cacheControl: 'public, max-age=900'
        '**/*.html':
          params:
            ACL: 'public-read'
            # This can hypothetically be changed to something cache friendly but my default
            # preference is that the pages are always revalidated
            cacheControl: 'no-cache, must-revalidate, max-age=0'
